---
import '~/styles/global.css';

import { I18N, METADATA } from 'site-config';

import CommonMeta from '~/components/meta/CommonMeta.astro';
import Favicons from '~/components/meta/Favicons.astro';
import Analytics from '~/components/meta/Analytics.astro';
import Metadata from '~/components/meta/Metadata.astro';
import SiteVerification from '~/components/meta/SiteVerification.astro';
import Container from '~/components/blocks/layout/Container.astro';
import type { MetaData } from '~/types/metadata.types';
import type { ContainerProps } from '~/types/container.types';
import { mergeConfigs } from '~/utils/mergeConfigs';
import Header from '~/components/blocks/composite/Header.astro';

import Footer from '~/components/blocks/composite/Footer.astro';
import type { ButtonProps } from '~/types/button.types';
import Modal from '~/components/blocks/layout/Modal.astro';
import NavigationTree from '~/components/blocks/composite/NavigationTree.astro';

import logoSrc from '~/assets/vectors/logo.svg?raw';

export type Props = {
  langCode?: string;
  metadata?: Partial<MetaData>;
  topmostContainer?: Partial<ContainerProps>;
};

const { langCode, metadata, topmostContainer } = Astro.props;

// Find the language configuration
const currentLang =
  I18N.languages.find((lang: (typeof I18N.languages)[number]) => lang.code === langCode) ||
  I18N.languages.find((lang: (typeof I18N.languages)[number]) => lang.code === I18N.default) ||
  I18N.languages[0];

const htmlLang = currentLang.code;
const htmlDir = currentLang.direction;

// Get color scheme from config
const colorScheme = METADATA.theme?.colorScheme || 'light dark';

const defaultTopmostContainer = {
  htmlTag: 'div',
  content: { air: 'none', widthType: 'full' },
} as ContainerProps;

const mergedTopmostContainer = mergeConfigs({}, defaultTopmostContainer, topmostContainer);

const navigationItems: ButtonProps[] = [
  { label: 'Les Succulentes', href: '#les-succulentes' },
  { label: 'Vision', href: '#vision' },
  { label: 'La Créatrice', href: '#creatrice' },
  { label: 'Autres Collections', href: '#autres-collections' },
  { label: 'Joaillerie sur mesure', href: '#joaillerie-sur-mesure' },
  { label: 'Contactez-moi', href: '#contactez-moi' },
];

const socialIcons: ButtonProps[] = [
  {
    icon: { name: 'tabler:brand-facebook-filled' },
    href: 'https://www.facebook.com/people/Sofia-Moreno/61576862935670/',
    target: '_blank',
  },
  {
    icon: { name: 'tabler:brand-instagram-filled' },
    href: 'https://www.instagram.com/sofiamoreno_paris/',
    target: '_blank',
  },
  {
    icon: { name: 'tabler:brand-linkedin-filled' },
    href: 'https://www.linkedin.com/in/sofiaku/',
    target: '_blank',
  },
];

const socialIconsHeader: ButtonProps[] = socialIcons.map((icon) => ({
  ...icon,
  class: 'hidden md:flex',
}));
---

<!doctype html>
<html lang={htmlLang} dir={htmlDir}>
  <head>
    <CommonMeta />
    <Favicons />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Initialize theme before page renders to prevent FOUC -->
    <script is:inline define:vars={{ colorScheme }}>
      (function () {
        // Parse color scheme config to determine behavior
        // Values: "normal", "light", "dark", "light dark", "dark light", "only light", "only dark"
        const scheme = colorScheme;

        if (scheme === 'only light') {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
          return;
        }
        if (scheme === 'only dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          return;
        }

        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'light' || storedTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', storedTheme);
          return;
        }

        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let theme;

        if (scheme === 'dark light') {
          theme = prefersDark ? 'dark' : 'light';
        } else {
          theme = prefersDark ? 'dark' : 'light';
        }

        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      })();
    </script>
  </head>
  <body>
    <Container {...mergedTopmostContainer}>
      <Header
        isFloating
        container={{
          content: { boxWidth: 'full' },
          background: {
            class: 'group-data-[scrolled]:bg-background/70 group-data-[scrolled]:backdrop-blur-sm',
          },
        }}
        logo={{
          vector: {
            src: logoSrc,
          },
          class: 'text-normal w-48 md:w-72 group-data-[scrolled]:w-48',
        }}
        defaultActionsConfig={{
          variant: 'link',
          class: 'text-normal hover:text-normal',
        }}
        actionsLeft={[
          {
            'data-modal-trigger': 'mobile-menu',
            icon: { name: 'heroicons:bars-3' },
          },
        ]}
        actionsRight={socialIconsHeader}
      />

      <slot />

      <Footer
        container={{
          background: {
            class: 'bg-surface',
          },
          border: {
            width: 'border-t',
            color: 'border-elevated',
          },
        }}
        logo={{
          vector: {
            src: logoSrc,
          },
          class: 'w-48 text-normal hover:text-normal',
        }}
        socialActions={socialIcons}
        disclaimer="Les créations présentées illustrent mon travail et parfois des collaborations. Chaque projet sur mesure est unique : résultats, délais et finitions varient selon le cahier des charges, les matériaux et votre implication. En commandant, vous acceptez la singularité et les éventuels ajustements du processus de conception et de fabrication."
        footnote="© 2026 <strong>Sofía Moreno</strong>. Tous droits réservés."
      />

      <Modal
        id="mobile-menu"
        size="full"
        class="bg-transparent rounded-none shadow-none flex items-center align-middle"
      >
        <NavigationTree
          items={navigationItems}
          defaultItemConfig={{ variant: 'link', size: 'xl' }}
        />
      </Modal>
    </Container>

    <!-- modal portal root: server-rendered root for portals (falls back to body append) -->
    <div id="modal-portal-root" class="z-9999"></div>
  </body>
</html>

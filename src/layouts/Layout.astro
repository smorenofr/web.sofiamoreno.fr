---
import '~/styles/global.css';

import { I18N, METADATA } from 'site-config';

import CommonMeta from '~/components/htmlheader/CommonMeta.astro';
import Favicons from '~/components/htmlheader/Favicons.astro';
import Analytics from '~/components/htmlheader/Analytics.astro';
import Metadata from '~/components/htmlheader/Metadata.astro';
import SiteVerification from '~/components/htmlheader/SiteVerification.astro';
import Container from '~/components/blocks/layout/Container.astro';
import type { MetaData } from '~/types/metadata.types';
import type { ContainerProps } from '~/types/container.types';
import { mergeConfigs } from '~/utils/mergeConfigs';

export type Props = {
  langCode?: string;
  metadata?: Partial<MetaData>;
  topmostContainer?: Partial<ContainerProps>;
};

const { langCode, metadata, topmostContainer } = Astro.props;

// Find the language configuration
const currentLang =
  I18N.languages.find((lang: (typeof I18N.languages)[number]) => lang.code === langCode) ||
  I18N.languages.find((lang: (typeof I18N.languages)[number]) => lang.code === I18N.default) ||
  I18N.languages[0];

const htmlLang = currentLang.code;
const htmlDir = currentLang.direction;

// Get color scheme from config
const colorScheme = METADATA.theme?.colorScheme || 'light dark';

const defaultTopmostContainer = {
  htmlTag: 'div',
  content: { air: 'none', widthType: 'full' },
} as ContainerProps;

const mergedTopmostContainer = mergeConfigs({}, defaultTopmostContainer, topmostContainer);
---

<!doctype html>
<html lang={htmlLang} dir={htmlDir}>
  <head>
    <CommonMeta />
    <Favicons />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Initialize theme before page renders to prevent FOUC -->
    <script is:inline define:vars={{ colorScheme }}>
      (function () {
        // Parse color scheme config to determine behavior
        // Values: "normal", "light", "dark", "light dark", "dark light", "only light", "only dark"
        const scheme = colorScheme;

        if (scheme === 'only light') {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
          return;
        }
        if (scheme === 'only dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          return;
        }

        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'light' || storedTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', storedTheme);
          return;
        }

        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let theme;

        if (scheme === 'dark light') {
          theme = prefersDark ? 'dark' : 'light';
        } else {
          theme = prefersDark ? 'dark' : 'light';
        }

        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      })();
    </script>
  </head>
  <body>
    <Container {...mergedTopmostContainer}>
      <slot />
    </Container>
    <!-- modal portal root: server-rendered root for portals (falls back to body append) -->
    <div id="modal-portal-root" class="z-9999"></div>
  </body>
</html>

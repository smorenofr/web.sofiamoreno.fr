---
import { getImage } from 'astro:assets';
import { findImage } from '~/utils/images';
import type { BackgroundProps } from '~/types/background.types';
import { cn } from '~/utils/styles';

type Props = BackgroundProps;

const { image, video, attachment = 'scroll', class: className = '', overlayClass } = Astro.props;

// Resolve image path (supports ~/assets/, public URLs, and external URLs)
let resolvedImageUrl = '';
if (image) {
  const resolvedImage = await findImage(image);

  if (typeof resolvedImage === 'string') {
    // Already a URL (public or external)
    resolvedImageUrl = resolvedImage;
  } else if (resolvedImage) {
    // ImageMetadata from ~/assets/ - optimize it
    const optimizedImage = await getImage({ src: resolvedImage });
    resolvedImageUrl = optimizedImage.src;
  }
}

// Build background classes
const bgClass = cn(
  'absolute inset-0 z-0',
  className,
  resolvedImageUrl && !className.includes('bg-') && 'bg-cover bg-center',
  resolvedImageUrl && attachment === 'fixed' && 'bg-fixed'
);

// Build inline styles for dynamic background-image URL
let bgStyle = '';
if (resolvedImageUrl) {
  bgStyle = `background-image:url('${resolvedImageUrl}');`;
}

// Overlay class for custom overlay
const overlay = overlayClass ?? '';
---

{
  video ? (
    <div class={bgClass}>
      <video
        class="absolute inset-0 w-full h-full object-cover"
        autoplay
        loop
        muted
        playsinline
        aria-hidden="true"
      >
        <source src={video} type="video/mp4" />
      </video>
      {overlay && <div class:list={['absolute inset-0', overlay]} />}
      <slot />
    </div>
  ) : resolvedImageUrl ? (
    <div class={bgClass} style={bgStyle}>
      {overlay && <div class:list={['absolute inset-0', overlay]} />}
      <slot />
    </div>
  ) : (
    <div class:list={[bgClass, overlay]}>
      <slot />
    </div>
  )
}

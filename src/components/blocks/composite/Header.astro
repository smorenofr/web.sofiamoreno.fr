---
import type { HeaderProps } from '~/types/header.types';
import { cn } from '~/utils/styles';
import { SITE } from 'site-config';
import Container from '../layout/Container.astro';
import Image from '../primitives/Image.astro';
import NavigationTreeHorizontal from './NavigationTreeHorizontal.astro';
import ThemeToggle from '../primitives/ThemeToggle.astro';
import Button from '../primitives/Button.astro';
import merge from 'lodash.merge';

type Props = HeaderProps;

const {
  isSticky = false,
  showThemeToggle = false,
  breakpoint = 'md',
  navigationAlign = 'center',
  actionsAir = 'normal',
  container,
  logoButton,
  navigationTreeHorizontal,
  themeToggle,
  actions = [],
  class: className = '',
  ...attrs
} = Astro.props;

const breakpointClasses = {
  sm: 'hidden sm:flex',
  md: 'hidden md:flex',
  lg: 'hidden lg:flex',
} as const;

const navigationAlignClasses = {
  left: 'justify-start',
  center: 'justify-center',
  right: 'justify-end',
} as const;

const actionsAirClasses = {
  none: 'gap-0',
  tight: 'gap-2',
  normal: 'gap-4',
  loose: 'gap-6',
} as const;

const defaultContainerConfig = {
  tag: 'nav',
  content: { air: 'none' },
  spacing: { padding: 'py-3 px-4 md:py-4 md:px-6 lg:px-8' },
};

const defaultLogoButtonConfig = {
  href: '/',
  variant: 'link' as const,
  intent: 'neutral' as const,
  label: logoButton?.image?.src ? undefined : SITE.name,
  labelClass: 'text-xl font-bold',
  class: 'shrink-0 p-0 hover:no-underline',
};

const mergedContainerConfig = merge({}, defaultContainerConfig, container);
const mergedLogoButtonConfig = merge({}, defaultLogoButtonConfig, logoButton);

const stickyClasses = isSticky ? 'sticky top-0 z-40' : '';

const headerLayoutClass = cn(
  'flex items-center gap-4',
  !navigationTreeHorizontal?.items && 'justify-between',
  className
);
---

<div class={stickyClasses}>
  <Container {...mergedContainerConfig} {...attrs}>
    <div class={headerLayoutClass}>
      <!-- Left Section: Logo -->
      {
        (mergedLogoButtonConfig.image?.src || mergedLogoButtonConfig.label) && (
          <Button {...mergedLogoButtonConfig}>
            {mergedLogoButtonConfig.image?.src && (
              <div class="w-auto h-12 max-w-48">
                <Image
                  {...mergedLogoButtonConfig.image}
                  alt={mergedLogoButtonConfig.image.alt || SITE.name}
                />
              </div>
            )}
          </Button>
        )
      }

      <!-- Center Section: Navigation (hidden on mobile) -->
      {
        navigationTreeHorizontal?.items && (
          <div
            class={cn(
              'grow',
              breakpointClasses[breakpoint],
              navigationAlignClasses[navigationAlign]
            )}
          >
            <NavigationTreeHorizontal {...navigationTreeHorizontal} />
          </div>
        )
      }

      <!-- Right Section: Theme Toggle + Actions -->
      <div class={cn('flex items-center shrink-0', actionsAirClasses[actionsAir])}>
        {showThemeToggle && <ThemeToggle {...themeToggle} />}

        {actions.map((action) => <Button {...action} />)}
      </div>
    </div>
  </Container>
</div>

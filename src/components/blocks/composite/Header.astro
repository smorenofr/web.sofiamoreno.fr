---
import type { HeaderProps } from '~/types/header.types';
import { cn } from '~/utils/styles';
import { SITE } from 'site-config';
import Container from '~/components/blocks/layout/Container.astro';
import Image from '~/components/blocks/primitives/Image.astro';
import Vector from '~/components/blocks/primitives/Vector.astro';
import NavigationTreeHorizontal from './NavigationTreeHorizontal.astro';
import ThemeToggle from '~/components/blocks/primitives/ThemeToggle.astro';
import Button from '~/components/blocks/primitives/Button.astro';
import merge from 'lodash.merge';

type Props = HeaderProps;

const {
  isSticky = false,
  isFloating = false,
  showThemeToggle = false,
  breakpoint = 'md',
  navigationAlign = 'center',
  actionsAir = 'normal',
  container,
  logoButton,
  navigationTreeHorizontal,
  themeToggle,
  actions = [],
  class: className = '',
  ...attrs
} = Astro.props;

const breakpointClasses = {
  sm: 'hidden sm:flex',
  md: 'hidden md:flex',
  lg: 'hidden lg:flex',
} as const;

const navigationAlignClasses = {
  left: 'justify-start',
  center: 'justify-center',
  right: 'justify-end',
} as const;

const actionsAirClasses = {
  none: 'gap-0',
  tight: 'gap-2',
  normal: 'gap-4',
  loose: 'gap-6',
} as const;

const defaultContainerConfig = {
  htmlTag: 'header',
  content: { air: 'none' },
  spacing: { padding: 'py-3 px-4 md:py-4 md:px-6 lg:px-8' },
};

const defaultLogoButtonConfig = {
  href: '/',
  variant: 'link' as const,
  intent: 'neutral' as const,
  label: logoButton?.vector?.src || logoButton?.image?.src ? undefined : SITE.name,
  labelClass: 'text-xl font-bold',
  class: 'shrink-0 p-0 hover:no-underline',
};

const mergedContainerConfig = merge({}, defaultContainerConfig, container);
const mergedLogoButtonConfig = merge({}, defaultLogoButtonConfig, logoButton);

const positionClasses = cn(
  'group',
  isFloating ? 'fixed top-0 left-0 right-0 z-50' : isSticky ? 'sticky top-0 z-40' : ''
);

const justifyClasses = navigationTreeHorizontal?.items
  ? `justify-between ${breakpoint}:justify-normal`
  : 'justify-between';

const headerLayoutClass = cn('flex items-center gap-4', justifyClasses, className);
---

<div class={positionClasses} data-header>
  <Container {...mergedContainerConfig} {...attrs}>
    <div class={headerLayoutClass}>
      <!-- Left Section: Logo -->
      {
        (mergedLogoButtonConfig.vector?.src ||
          mergedLogoButtonConfig.image?.src ||
          mergedLogoButtonConfig.label) && (
          <Button {...mergedLogoButtonConfig}>
            {mergedLogoButtonConfig.vector?.src ? (
              <div class="w-auto h-12 max-w-48">
                <Vector
                  {...mergedLogoButtonConfig.vector}
                  class={cn('w-full h-full', mergedLogoButtonConfig.vector.class)}
                  ariaLabel={mergedLogoButtonConfig.vector.ariaLabel || SITE.name}
                />
              </div>
            ) : mergedLogoButtonConfig.image?.src ? (
              <div class="w-auto h-12 max-w-48">
                <Image
                  {...mergedLogoButtonConfig.image}
                  alt={mergedLogoButtonConfig.image.alt || SITE.name}
                />
              </div>
            ) : null}
          </Button>
        )
      }

      <!-- Center Section: Navigation (hidden on mobile) -->
      {
        navigationTreeHorizontal?.items && (
          <div
            class={cn(
              'grow',
              breakpointClasses[breakpoint],
              navigationAlignClasses[navigationAlign]
            )}
          >
            <NavigationTreeHorizontal {...navigationTreeHorizontal} />
          </div>
        )
      }

      <!-- Right Section: Theme Toggle + Actions -->
      <div class={cn('flex items-center shrink-0', actionsAirClasses[actionsAir])}>
        {showThemeToggle && <ThemeToggle {...themeToggle} />}

        {
          actions && actions.length > 0 && (
            <div class="flex flex-row gap-1">
              {actions.map((action) => (
                <Button {...action} />
              ))}
            </div>
          )
        }
      </div>
    </div>
  </Container>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('[data-header]') as HTMLElement;
    if (!header) return;

    const handleScroll = () => {
      const headerHeight = header.offsetHeight;

      if (window.scrollY > headerHeight) {
        header.setAttribute('data-scrolled', 'true');
      } else {
        header.removeAttribute('data-scrolled');
      }
    };

    // Initial check
    handleScroll();

    // Listen to scroll
    window.addEventListener('scroll', handleScroll, { passive: true });
  });
</script>

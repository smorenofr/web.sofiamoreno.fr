---
import type { HeaderProps } from '~/types/header.types';
import { cn } from '~/utils/styles';
import Container from '~/components/blocks/layout/Container.astro';
import NavigationTreeHorizontal from './NavigationTreeHorizontal.astro';
import ThemeToggle from '~/components/blocks/primitives/ThemeToggle.astro';
import Button from '~/components/blocks/primitives/Button.astro';
import type { ButtonProps } from '~/types/button.types';
import type { ContainerProps } from '~/types/container.types';
import Logo from '~/components/blocks/primitives/Logo.astro';
import { mergeConfigs } from '~/utils/mergeConfigs';

type Props = HeaderProps;

const {
  isSticky = false,
  isFloating = false,
  showThemeToggle = false,
  actionsAir = 'normal',
  container,
  logo,
  navigationLeft,
  navigationRight,
  themeToggle,
  actionsLeft = [],
  actionsRight = [],
  defaultActionsConfig,
  class: className = '',
  ...attrs
} = Astro.props;

const actionsAirClasses = {
  none: 'gap-0',
  tight: 'gap-2',
  normal: 'gap-4',
  loose: 'gap-6',
} as const;

const defaultContainerConfig = {
  htmlTag: 'header',
  content: { air: 'none' },
  spacing: { padding: 'py-3 px-4 md:py-4 md:px-6 lg:px-8' },
} as ContainerProps;

const baseActionsConfig: Partial<ButtonProps> = {
  variant: 'ghost',
  intent: 'neutral',
  shape: 'rounded',
  width: 'auto',
};

const mergedContainerConfig = mergeConfigs({}, defaultContainerConfig, container);

const topClasses = cn(
  'group header-transitions',
  isFloating ? 'fixed top-0 left-0 right-0 z-50' : isSticky ? 'sticky top-0 z-40' : ''
);

const headerLayoutClass = cn('relative flex items-center justify-between', className);
---

<div class={topClasses} data-header>
  <Container {...mergedContainerConfig} {...attrs}>
    <div class={headerLayoutClass}>
      <!-- Left Zone: navigationLeft + actionsLeft -->
      <div class="flex items-center gap-2">
        {
          actionsLeft && actionsLeft.length > 0 && (
            <div class={cn('flex flex-row gap-1', actionsAirClasses[actionsAir])}>
              {actionsLeft.map((action) => {
                const mergedAction = mergeConfigs(
                  {},
                  baseActionsConfig,
                  defaultActionsConfig,
                  action
                );
                return <Button {...mergedAction} />;
              })}
            </div>
          )
        }

        {navigationLeft?.items && <NavigationTreeHorizontal {...navigationLeft} />}
      </div>

      <!-- Center spacer: invisible but occupies flow so header retains height -->
      <div
        aria-hidden="true"
        class="opacity-0 flex items-center justify-center pointer-events-none"
      >
        <Logo {...logo} />
      </div>

      <!-- Center Zone: Logo (always visually centered) -->
      <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
        <Logo {...logo} />
      </div>

      <!-- Right Zone: navigationRight + actionsRight + theme toggle -->
      <div class="flex items-center gap-2">
        {navigationRight?.items && <NavigationTreeHorizontal {...navigationRight} />}

        {showThemeToggle && <ThemeToggle {...themeToggle} />}

        {
          actionsRight && actionsRight.length > 0 && (
            <div class={cn('flex flex-row gap-1', actionsAirClasses[actionsAir])}>
              {actionsRight.map((action) => {
                const mergedAction = mergeConfigs(
                  {},
                  baseActionsConfig,
                  defaultActionsConfig,
                  action
                );
                return <Button {...mergedAction} />;
              })}
            </div>
          )
        }
      </div>
    </div>
  </Container>
</div>

<script>
  (function () {
    const initHeaderScroll = () => {
      const header = document.querySelector('[data-header]');
      if (!header) return;
      if (window.__headerScrollInitialized) return;

      const handleScroll = () => {
        const headerHeight = (header as HTMLElement).offsetHeight;
        if (window.scrollY > headerHeight) {
          header.setAttribute('data-scrolled', 'true');
        } else {
          header.removeAttribute('data-scrolled');
        }
      };

      // Initial check
      handleScroll();

      // Listen to scroll
      window.addEventListener('scroll', handleScroll, { passive: true });
      window.__headerScrollInitialized = true;
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeaderScroll);
    } else {
      initHeaderScroll();
    }
  })();
</script>
